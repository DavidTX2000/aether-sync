#!/data/data/com.termux/files/usr/bin/sh
# AETHER-SYNC MASTER v3.1.0 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
BLUE="\033[1;34m"
YELLOW="\033[1;33m"
CYAN="\033[1;36m"
RESET="\033[0m"

# Função para buscar arquivos na Shadow (Trace)
trace() {
    echo "${BLUE}[AETHER]${RESET} ${CYAN}Searching for '$1' in Shadow...${RESET}"
    find "$SHADOW" -name "*$1*" 2>/dev/null | sed "s|$SHADOW|~#aether|"
}

# Função de estatísticas (Stats)
stats() {
    SIZE=$(du -sh "$SHADOW" | awk '{print $1}')
    FILES=$(find "$SHADOW" | wc -l)
    echo "${BLUE}[AETHER]${RESET} ${CYAN}Shadow Statistics:${RESET}"
    echo " - Total Size: ${YELLOW}$SIZE${RESET}"
    echo " - Total Linked/Cloned Files: ${YELLOW}$FILES${RESET}"
    echo " - Root Path: $SHADOW"
}

purge() {
    echo "${BLUE}[AETHER]${RESET} Purging all shadow files..."
    rm -rf "$SHADOW"/*
    echo "[OK] Storage cleared."
}

morph() {
    FREE_SPACE=$(df /data | awk 'NR==2 {print $4}')
    FREE_GB=$(expr $FREE_SPACE / 1024 / 1024)
    mkdir -p "$SHADOW"
    
    if [ "$FREE_GB" -lt 10 ]; then
        echo "${BLUE}[AETHER]${RESET} ${YELLOW}Warning: Low storage ($FREE_GB GB). Link Mode active.${RESET}"
        for d in /system /vendor /etc /apex; do
            mkdir -p "$SHADOW$d" 2>/dev/null
            ls -d "$d"/* 2>/dev/null | xargs -I {} ln -sf {} "$SHADOW{}" 2>/dev/null
        done
    else
        echo "${BLUE}[AETHER]${RESET} High storage ($FREE_GB GB). Full Clone active."
        for d in /system /vendor /etc; do
            cp -a "$d" "$SHADOW/" 2>/dev/null
        done
    fi

    export PATH="$SHADOW/system/bin:$SHADOW/vendor/bin:$PATH"
    echo "export PS1='~#aether\$(echo \$PWD | sed \"s|$SHADOW||\" | sed \"s|/data/data/com.termux/files/home|~|\")\$: '" > "$SHADOW/.aether_profile"
    ENV="$SHADOW/.aether_profile" sh -i
}

case "$1" in
    --morph) morph ;;
    --kill)  purge ;;
    --trace) trace "$2" ;;
    --stats) stats ;;
    *) echo "Usage: aether [--morph|--kill|--trace <name>|--stats]" ;;
esac
