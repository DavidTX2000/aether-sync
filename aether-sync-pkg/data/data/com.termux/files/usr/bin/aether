#!/data/data/com.termux/files/usr/bin/sh
# AETHER-SYNC ULTRA v4.0.0 - DavidTX2000

SHADOW="/data/data/com.termux/files/usr/share/aether/shadow"
BLUE="\033[1;34m"
CYAN="\033[1;36m"
RESET="\033[0m"

stats() {
    [ ! -d "$SHADOW" ] && echo "Shadow não iniciada." && return
    SIZE=$(du -sh "$SHADOW" | awk '{print $1}')
    FILES=$(find "$SHADOW" | wc -l)
    echo "${BLUE}[AETHER]${RESET} ${CYAN}Stats:${RESET} Size: $SIZE | Files: $FILES"
}

morph() {
    mkdir -p "$SHADOW/storage" "$SHADOW/sdcard" "$SHADOW/system" "$SHADOW/etc"
    
    # Mirroring (Sem copiar, apenas linkando para ser instantâneo e economizar seus 3GB)
    echo "${BLUE}[AETHER]${RESET} Interceptando partições..."
    ln -sf /sdcard/* "$SHADOW/sdcard/" 2>/dev/null
    ln -sf /storage/* "$SHADOW/storage/" 2>/dev/null
    
    # Criando o Ambiente Enclausurado (The Cage)
    # Aqui forçamos o Shell a reescrever o comportamento dos comandos
    cat <<OP > "$SHADOW/.bashrc"
export PATH="$SHADOW/system/bin:$PATH"
alias ls='ls --color=auto'
alias cp='cp -iv'
# O TRUQUE: Redireciona qualquer comando que aponte para pastas raiz
alias cd='_cd(){ case "\$1" in /*) builtin cd "$SHADOW\$1" ;; *) builtin cd "\$1" ;; esac; }; _cd'
alias cp='_cp(){ arg1=\$1; arg2=\$2; [[ "\$arg1" == /* ]] && arg1="$SHADOW\$1"; [[ "\$arg2" == /* ]] && arg2="$SHADOW\$2"; /system/bin/cp "\$arg1" "\$arg2"; }; _cp'

export PS1='${BLUE}AETHER${RESET}:${CYAN}\w${RESET}\$ '
echo "Bem-vindo ao Ambiente Interceptado. Sem Root, Total Controle."
OP

    # Entra no ambiente usando o bash do sistema mas com o nosso perfil enclausurado
    sh --rcfile "$SHADOW/.bashrc" -i
}

purge() {
    rm -rf "$SHADOW"/* && echo "Shadow destruída."
}

case "$1" in
    --morph) morph ;;
    --stats) stats ;;
    --kill) purge ;;
    *) echo "Usage: aether [--morph|--kill|--stats]" ;;
esac
